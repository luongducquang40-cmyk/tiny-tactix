<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Tiny Tactix</title>

<!-- CDN Phaser ổn định cho iOS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0c1022;
  overflow: hidden;
}
</style>
</head>

<body>

<script>
window.onload = function () {

const TILE = 90;
const COLS = 6;
const ROWS = 4;
let turn = "player";
let selected = null;
let mapIndex = 0;

const MAPS = [
  { player: [[0,1],[0,2]], ai: [[5,1],[5,2]] },
  { player: [[0,0],[0,3]], ai: [[5,0],[5,3]] },
  { player: [[1,1],[1,2]], ai: [[4,1],[4,2]] }
];

class Unit {
  constructor(scene,x,y,type,owner){
    this.scene = scene;
    this.x = x;
    this.y = y;
    this.owner = owner;
    this.type = type;

    const stats = {
      tank: [8, 0x4dabf7],
      dps:  [5, 0x51cf66],
      mage: [4, 0xf06595]
    };

    this.maxHp = stats[type][0];
    this.hp = this.maxHp;

    this.sprite = scene.add.circle(
      x*TILE+45, y*TILE+45, 30, stats[type][1]
    );

    this.hpBg = scene.add.rectangle(this.sprite.x, this.sprite.y-36, 44, 6, 0x000000);
    this.hpBar = scene.add.rectangle(this.sprite.x-22, this.sprite.y-36, 44, 6, 0x00ff00)
      .setOrigin(0,0.5);
  }

  updateHP(){
    this.hpBar.width = 44 * (this.hp / this.maxHp);
  }

  move(x,y){
    this.x = x; this.y = y;
    this.sprite.x = x*TILE+45;
    this.sprite.y = y*TILE+45;
    this.hpBg.x = this.sprite.x;
    this.hpBar.x = this.sprite.x-22;
    this.hpBg.y = this.hpBar.y = this.sprite.y-36;
  }

  adjacent(o){
    return Math.abs(this.x-o.x) + Math.abs(this.y-o.y) === 1;
  }

  attack(target){
    target.hp -= (this.type === "dps" ? 2 : 1);
    target.updateHP();
    this.scene.tweens.add({
      targets: this.sprite,
      scale: 1.2,
      yoyo: true,
      duration: 120
    });
  }

  destroy(){
    this.sprite.destroy();
    this.hpBg.destroy();
    this.hpBar.destroy();
  }
}

class Menu extends Phaser.Scene {
  constructor(){ super("Menu"); }
  create(){
    this.add.text(120,120,"TINY TACTIX",{fontSize:"40px",color:"#ffffff"});
    this.add.text(160,200,"START",{fontSize:"28px",color:"#00ff88"})
      .setInteractive()
      .on("pointerdown",()=>this.scene.start("Game"));
  }
}

class Game extends Phaser.Scene {
  constructor(){ super("Game"); }

  create(){
    this.units = [];
    turn = "player";
    selected = null;

    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        this.add.rectangle(
          x*TILE+45, y*TILE+45,
          TILE-4, TILE-4, 0x2c2f5a
        ).setStrokeStyle(2,0xffffff);
      }
    }

    const m = MAPS[mapIndex];
    this.units.push(new Unit(this,m.player[0][0],m.player[0][1],"tank","player"));
    this.units.push(new Unit(this,m.player[1][0],m.player[1][1],"mage","player"));
    this.units.push(new Unit(this,m.ai[0][0],m.ai[0][1],"tank","ai"));
    this.units.push(new Unit(this,m.ai[1][0],m.ai[1][1],"dps","ai"));

    this.info = this.add.text(10, ROWS*TILE+10, "TURN: PLAYER", {fontSize:"20px",color:"#fff"});

    this.input.on("pointerdown", p => {
      if(turn !== "player") return;
      const x = Math.floor(p.x / TILE);
      const y = Math.floor(p.y / TILE);

      if(!selected){
        selected = this.units.find(u=>u.owner==="player");
        return;
      }

      const enemy = this.units.find(u=>u.owner==="ai" && u.x===x && u.y===y);
      if(enemy && selected.adjacent(enemy)){
        selected.attack(enemy);
        if(enemy.hp<=0){
          enemy.destroy();
          this.units = this.units.filter(u=>u!==enemy);
        }
        this.endTurn();
        return;
      }

      selected.move(x,y);
      this.endTurn();
    });
  }

  endTurn(){
    selected = null;
    turn = "ai";
    this.info.setText("TURN: AI");
    this.time.delayedCall(600, ()=>this.aiTurn());
  }

  aiTurn(){
    const ai = this.units.filter(u=>u.owner==="ai");
    const player = this.units.filter(u=>u.owner==="player");

    ai.forEach(a=>{
      const p = player[0];
      if(!p) return;

      if(a.adjacent(p)){
        a.attack(p);
        if(p.hp<=0){
          p.destroy();
          this.units = this.units.filter(u=>u!==p);
        }
      } else {
        a.move(a.x + Math.sign(p.x-a.x), a.y + Math.sign(p.y-a.y));
      }
    });

    if(this.units.filter(u=>u.owner==="player").length===0){
      this.info.setText("AI WIN");
      return;
    }

    if(this.units.filter(u=>u.owner==="ai").length===0){
      this.info.setText("STAGE CLEAR");
      mapIndex = (mapIndex+1) % MAPS.length;
      this.time.delayedCall(1000, ()=>this.scene.restart());
      return;
    }

    turn = "player";
    this.info.setText("TURN: PLAYER");
  }
}

new Phaser.Game({
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: "#0c1022",
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: [Menu, Game]
});

};
</script>

</body>
</html>
